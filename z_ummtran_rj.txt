z_ummtran_rj01:--z_ummtran_rj01 
    declare @t_bdate nvarchar(20) = case when '#non'=[1] then '' else [1] end
    declare @t_edate nvarchar(20) = case when '#non'=[2] then char(255) else [2] end
    declare @t_bcustno nvarchar(20) = case when '#non'=[3] then '' else [3] end
    declare @t_ecustno nvarchar(20) = case when '#non'=[4] then char(255) else [4] end
    
    declare @tmp table(
        trandate nvarchar(10),
        custno nvarchar(20),
        tranaccy nvarchar(10),
        tranno nvarchar(20),
        straddrno nvarchar(20),
        endaddrno nvarchar(20),
        inmount float,
        mount3 float,
        mount4 float,
        unit nvarchar(20),
        price float,
        tranmoney float,
        
        trdaccy nvarchar(10),
        trdno nvarchar(20),
        trdmoney float,
        
        diff float,
        memo nvarchar(max)
    )

    insert into @tmp(trandate,custno,tranaccy,tranno,straddrno,endaddrno,inmount,mount3,mount4
        ,trdaccy,trdno,trdmoney)
    select a.trandate,a.custno,a.accy,a.noa,a.straddrno,a.endaddrno,a.inmount,a.mount3,a.mount4
        ,ISNULL(b.accy,''),isnull(b.noa,''),ISNULL(b.tranmoney,0)
    from view_trans a
    left join view_trds b on a.noa=b.tranno 
    where  a.trandate between @t_bdate and @t_edate
    and a.custno between @t_bcustno and @t_ecustno
    
    update @tmp set unit=b.driverunit,price=b.driverprice
        ,tranmoney = round(case ISNULL(b.driverunit,'') when '台數' then a.inmount 
            when '米數' then a.mount3 when '噸數' then a.mount4 else 0 end*isnull(b.driverprice,0),0)
    from @tmp a
    outer apply (select top 1 x.driverunit,x.driverprice 
        from addrs x
        left join addr y on x.noa=y.noa 
        where a.straddrno=y.straddrno and a.endaddrno=y.endaddrno and datea<=a.trandate order by datea desc) b
    
    update @tmp set diff = isnull(tranmoney,0)-isnull(trdmoney,0)
    
    select * from @tmp;